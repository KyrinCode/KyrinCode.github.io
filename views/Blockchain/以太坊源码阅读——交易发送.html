<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>以太坊源码阅读——交易发送 | KyrinCode</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
    <meta name="description" content="Valar Morghulis, Valar Dohaeris.">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.ab2f6801.css" as="style"><link rel="preload" href="/assets/js/app.35d653e3.js" as="script"><link rel="preload" href="/assets/js/5.5164febf.js" as="script"><link rel="preload" href="/assets/js/1.2bbc4f55.js" as="script"><link rel="preload" href="/assets/js/10.c3d64b5d.js" as="script"><link rel="prefetch" href="/assets/js/11.ed5a2b1d.js"><link rel="prefetch" href="/assets/js/12.de760ffc.js"><link rel="prefetch" href="/assets/js/13.153c1add.js"><link rel="prefetch" href="/assets/js/14.ba2cea4a.js"><link rel="prefetch" href="/assets/js/15.680ac9b0.js"><link rel="prefetch" href="/assets/js/16.66652c5f.js"><link rel="prefetch" href="/assets/js/17.9508e148.js"><link rel="prefetch" href="/assets/js/18.d8063922.js"><link rel="prefetch" href="/assets/js/19.9e012a12.js"><link rel="prefetch" href="/assets/js/20.5152ddd9.js"><link rel="prefetch" href="/assets/js/21.525be65c.js"><link rel="prefetch" href="/assets/js/22.09446b6a.js"><link rel="prefetch" href="/assets/js/23.c7b0aa62.js"><link rel="prefetch" href="/assets/js/24.905af26d.js"><link rel="prefetch" href="/assets/js/25.9a9ba9e0.js"><link rel="prefetch" href="/assets/js/26.5ae019fa.js"><link rel="prefetch" href="/assets/js/27.a792ef15.js"><link rel="prefetch" href="/assets/js/28.a40b0cbe.js"><link rel="prefetch" href="/assets/js/29.f8c373d4.js"><link rel="prefetch" href="/assets/js/3.32d0e8ff.js"><link rel="prefetch" href="/assets/js/30.3461016c.js"><link rel="prefetch" href="/assets/js/31.e2d41aac.js"><link rel="prefetch" href="/assets/js/32.960ed13e.js"><link rel="prefetch" href="/assets/js/33.ada483d0.js"><link rel="prefetch" href="/assets/js/34.21969e1e.js"><link rel="prefetch" href="/assets/js/35.e6a903bb.js"><link rel="prefetch" href="/assets/js/36.fb70363e.js"><link rel="prefetch" href="/assets/js/37.3667590c.js"><link rel="prefetch" href="/assets/js/38.34f3fc95.js"><link rel="prefetch" href="/assets/js/39.f618c9c6.js"><link rel="prefetch" href="/assets/js/4.3b3b5a5f.js"><link rel="prefetch" href="/assets/js/40.2c4c92e7.js"><link rel="prefetch" href="/assets/js/41.2acfd3cb.js"><link rel="prefetch" href="/assets/js/42.a8a05d8b.js"><link rel="prefetch" href="/assets/js/43.50fbf123.js"><link rel="prefetch" href="/assets/js/44.5e689ab5.js"><link rel="prefetch" href="/assets/js/45.a56fd598.js"><link rel="prefetch" href="/assets/js/46.5e4e96ee.js"><link rel="prefetch" href="/assets/js/47.de492f00.js"><link rel="prefetch" href="/assets/js/48.c0f4fccb.js"><link rel="prefetch" href="/assets/js/49.2e51020e.js"><link rel="prefetch" href="/assets/js/50.681a300e.js"><link rel="prefetch" href="/assets/js/51.f28344c8.js"><link rel="prefetch" href="/assets/js/52.0900b7a3.js"><link rel="prefetch" href="/assets/js/53.8bbc0dfa.js"><link rel="prefetch" href="/assets/js/54.4f790507.js"><link rel="prefetch" href="/assets/js/55.87200beb.js"><link rel="prefetch" href="/assets/js/56.325d8a4e.js"><link rel="prefetch" href="/assets/js/57.9471061a.js"><link rel="prefetch" href="/assets/js/58.7e3ee477.js"><link rel="prefetch" href="/assets/js/59.53e69b3a.js"><link rel="prefetch" href="/assets/js/6.78705388.js"><link rel="prefetch" href="/assets/js/60.a7736818.js"><link rel="prefetch" href="/assets/js/61.e899b1f8.js"><link rel="prefetch" href="/assets/js/62.8175b41d.js"><link rel="prefetch" href="/assets/js/63.b0663415.js"><link rel="prefetch" href="/assets/js/64.3dbba7f9.js"><link rel="prefetch" href="/assets/js/7.1fb9f36c.js"><link rel="prefetch" href="/assets/js/8.ca37ae1c.js"><link rel="prefetch" href="/assets/js/9.29c8e861.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ab2f6801.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-19557b78><div data-v-19557b78><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-19557b78 data-v-19557b78><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-19557b78 data-v-19557b78><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>KyrinCode</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Kyrin</span>
            
          <span data-v-64685f0e>2020 - </span>
          2021
        </a></span></div></div> <div class="hide" data-v-19557b78><header class="navbar" data-v-19557b78><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="KyrinCode" class="logo"> <span class="site-name">KyrinCode</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Algorithm/" class="nav-link"><i class="iconfont undefined"></i>
  Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/categories/Blockchain/" class="nav-link"><i class="iconfont undefined"></i>
  Blockchain
</a></li><li class="dropdown-item"><!----> <a href="/categories/Language/" class="nav-link"><i class="iconfont undefined"></i>
  Language
</a></li><li class="dropdown-item"><!----> <a href="/categories/Paper/" class="nav-link"><i class="iconfont undefined"></i>
  Paper
</a></li><li class="dropdown-item"><!----> <a href="/categories/Technique/" class="nav-link"><i class="iconfont undefined"></i>
  Technique
</a></li><li class="dropdown-item"><!----> <a href="/categories/Travel/" class="nav-link"><i class="iconfont undefined"></i>
  Travel
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/KyrinCode" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="/views/Blockchain/.html#" class="nav-link"><i class="iconfont reco-wechat"></i>
  WeChat
</a></li><li class="dropdown-item"><!----> <a href="/views/Blockchain/.html#" class="nav-link"><i class="iconfont reco-mail"></i>
  Email
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-19557b78></div> <aside class="sidebar" data-v-19557b78><div class="personal-info-wrapper" data-v-b038cec6><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-b038cec6> <h3 class="name" data-v-b038cec6>
    Kyrin
  </h3> <div class="num" data-v-b038cec6><div data-v-b038cec6><h3 data-v-b038cec6>45</h3> <h6 data-v-b038cec6>Article</h6></div> <div data-v-b038cec6><h3 data-v-b038cec6>38</h3> <h6 data-v-b038cec6>Tag</h6></div></div> <hr data-v-b038cec6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Algorithm/" class="nav-link"><i class="iconfont undefined"></i>
  Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/categories/Blockchain/" class="nav-link"><i class="iconfont undefined"></i>
  Blockchain
</a></li><li class="dropdown-item"><!----> <a href="/categories/Language/" class="nav-link"><i class="iconfont undefined"></i>
  Language
</a></li><li class="dropdown-item"><!----> <a href="/categories/Paper/" class="nav-link"><i class="iconfont undefined"></i>
  Paper
</a></li><li class="dropdown-item"><!----> <a href="/categories/Technique/" class="nav-link"><i class="iconfont undefined"></i>
  Technique
</a></li><li class="dropdown-item"><!----> <a href="/categories/Travel/" class="nav-link"><i class="iconfont undefined"></i>
  Travel
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/KyrinCode" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="/views/Blockchain/.html#" class="nav-link"><i class="iconfont reco-wechat"></i>
  WeChat
</a></li><li class="dropdown-item"><!----> <a href="/views/Blockchain/.html#" class="nav-link"><i class="iconfont reco-mail"></i>
  Email
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>以太坊源码阅读——交易发送</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html#发起交易" class="sidebar-link">发起交易</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html#创建交易" class="sidebar-link">创建交易</a></li></ul></li><li><a href="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html#交易签名" class="sidebar-link">交易签名</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html#生成交易hash值" class="sidebar-link">生成交易hash值</a></li><li class="sidebar-sub-header"><a href="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html#根据hash值和私钥生成签名" class="sidebar-link">根据hash值和私钥生成签名</a></li><li class="sidebar-sub-header"><a href="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html#填充签名数据" class="sidebar-link">填充签名数据</a></li></ul></li><li><a href="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html#提交交易" class="sidebar-link">提交交易</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html#提交交易到txpool" class="sidebar-link">提交交易到txpool</a></li><li class="sidebar-sub-header"><a href="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html#创建智能合约地址" class="sidebar-link">创建智能合约地址</a></li></ul></li><li><a href="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html#广播交易" class="sidebar-link">广播交易</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html#执行交易" class="sidebar-link">执行交易</a></li><li class="sidebar-sub-header"><a href="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html#广播给其他节点" class="sidebar-link">广播给其他节点</a></li></ul></li><li><a href="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html#markmap" class="sidebar-link">Markmap</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html#参考资料" class="sidebar-link">参考资料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-19557b78><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>以太坊源码阅读——交易发送</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Kyrin</span>
            
          <span data-v-64685f0e>2020 - </span>
          2021
        </a></span></div></div> <div data-v-19557b78><main class="page"><div class="page-title" style="display:none;"><h1>以太坊源码阅读——交易发送</h1> <hr> <div data-v-484a899e><i class="iconfont reco-account" data-v-484a899e><span data-v-484a899e>Kyrin</span></i> <i class="iconfont reco-date" data-v-484a899e><span data-v-484a899e>2020-12-08</span></i> <i class="iconfont reco-eye" data-v-484a899e><span id="/views/Blockchain/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E2%80%94%E2%80%94%E4%BA%A4%E6%98%93%E5%8F%91%E9%80%81.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-484a899e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="iconfont reco-tag tags" data-v-484a899e><span class="tag-item" data-v-484a899e>
      以太坊源码
    </span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><p>以太坊源码 v1.9.24 阅读——交易发送</p> <p>以太坊交易发送基本流程：</p> <p><img src="/assets/img/eth01.d3491d51.png" alt="eth01"></p> <ul><li>发起交易：指定目标地址和交易金额，以及需要的 gas/gaslimit</li> <li>交易签名：使用账户私钥对交易进行签名</li> <li>提交交易：把交易加入到交易缓冲池 txpool 中（会先对交易签名进行验证）</li> <li>广播交易：通知 EVM 执行，同时把交易信息广播给其他结点</li></ul> <h2 id="发起交易"><a href="#发起交易" class="header-anchor">#</a> 发起交易</h2> <p>用户通过 JSON RPC 发起 eth_sendTransaction 请求，最终会调用 PublicTransactionPoolAPI</p> <p>的实现 SendTransaction() 函数（internal/ethapi/api.go）：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// SendTransaction creates a transaction for the given argument, sign it and submit it to the</span>
<span class="token comment">// transaction pool.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>PublicTransactionPoolAPI<span class="token punctuation">)</span> <span class="token function">SendTransaction</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> args SendTxArgs<span class="token punctuation">)</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Look up the wallet containing the requested signer</span>
	account <span class="token operator">:=</span> accounts<span class="token punctuation">.</span>Account<span class="token punctuation">{</span>Address<span class="token punctuation">:</span> args<span class="token punctuation">.</span>From<span class="token punctuation">}</span>

	wallet<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>b<span class="token punctuation">.</span><span class="token function">AccountManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span> <span class="token comment">// 根据地址找到对应的钱包</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> args<span class="token punctuation">.</span>Nonce <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// Hold the addresse's mutex around signing to prevent concurrent assignment of</span>
		<span class="token comment">// the same nonce to multiple accounts.</span>
		s<span class="token punctuation">.</span>nonceLock<span class="token punctuation">.</span><span class="token function">LockAddr</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>From<span class="token punctuation">)</span>
		<span class="token keyword">defer</span> s<span class="token punctuation">.</span>nonceLock<span class="token punctuation">.</span><span class="token function">UnlockAddr</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>From<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Set some sanity defaults and terminate on failure</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> args<span class="token punctuation">.</span><span class="token function">setDefaults</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> s<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token comment">// Assemble the transaction and sign with the wallet</span>
	tx <span class="token operator">:=</span> args<span class="token punctuation">.</span><span class="token function">toTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 创建交易</span>

	signed<span class="token punctuation">,</span> err <span class="token operator">:=</span> wallet<span class="token punctuation">.</span><span class="token function">SignTx</span><span class="token punctuation">(</span>account<span class="token punctuation">,</span> tx<span class="token punctuation">,</span> s<span class="token punctuation">.</span>b<span class="token punctuation">.</span><span class="token function">ChainConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ChainID<span class="token punctuation">)</span> <span class="token comment">// 交易签名</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">SubmitTransaction</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> s<span class="token punctuation">.</span>b<span class="token punctuation">,</span> signed<span class="token punctuation">)</span> <span class="token comment">// 提交交易</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>根据 From 地址查找对应的钱包 wallet，检查参数后，做了 3 件事：</p> <ul><li>通过 SendTxArgs.toTransaction() 创建交易</li> <li>通过 Wallet.SignTx() 对交易进行签名</li> <li>通过 submitTransaction() 提交交易</li></ul> <h3 id="创建交易"><a href="#创建交易" class="header-anchor">#</a> 创建交易</h3> <p>SendTxArgs 类型的定义（internal/ethapi/api.go）：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// SendTxArgs represents the arguments to sumbit a new transaction into the transaction pool.</span>
<span class="token keyword">type</span> SendTxArgs <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	From     common<span class="token punctuation">.</span>Address  <span class="token string">`json:&quot;from&quot;`</span>
	To       <span class="token operator">*</span>common<span class="token punctuation">.</span>Address <span class="token string">`json:&quot;to&quot;`</span>
	Gas      <span class="token operator">*</span>hexutil<span class="token punctuation">.</span>Uint64 <span class="token string">`json:&quot;gas&quot;`</span>
	GasPrice <span class="token operator">*</span>hexutil<span class="token punctuation">.</span>Big    <span class="token string">`json:&quot;gasPrice&quot;`</span>
	Value    <span class="token operator">*</span>hexutil<span class="token punctuation">.</span>Big    <span class="token string">`json:&quot;value&quot;`</span>
	Nonce    <span class="token operator">*</span>hexutil<span class="token punctuation">.</span>Uint64 <span class="token string">`json:&quot;nonce&quot;`</span>
	<span class="token comment">// We accept &quot;data&quot; and &quot;input&quot; for backwards-compatibility reasons. &quot;input&quot; is the</span>
	<span class="token comment">// newer name and should be preferred by clients.</span>
	Data  <span class="token operator">*</span>hexutil<span class="token punctuation">.</span>Bytes <span class="token string">`json:&quot;data&quot;`</span>
	Input <span class="token operator">*</span>hexutil<span class="token punctuation">.</span>Bytes <span class="token string">`json:&quot;input&quot;`</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>和 JSON 字段相应，包括了地址、gas、金额这些交易信息，nonce 是一个随账户交易次数自增的数字，一般会自动填充。交易还可以携带一些额外数据，存放在 data 或者 input 字段中，推荐用 input，data 是为了向后兼容。</p> <p>toTransaction() 函数（internal/ethapi/api.go）：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>args <span class="token operator">*</span>SendTxArgs<span class="token punctuation">)</span> <span class="token function">toTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction <span class="token punctuation">{</span>
	<span class="token keyword">var</span> input <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>Input <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		input <span class="token operator">=</span> <span class="token operator">*</span>args<span class="token punctuation">.</span>Input
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> args<span class="token punctuation">.</span>Data <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		input <span class="token operator">=</span> <span class="token operator">*</span>args<span class="token punctuation">.</span>Data
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>To <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// 没有目的账户便是创建合约账户，否则是普通交易，无论哪个都会返回一个Transaction实例</span>
		<span class="token keyword">return</span> types<span class="token punctuation">.</span><span class="token function">NewContractCreation</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">.</span>Nonce<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">.</span>Gas<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>GasPrice<span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> types<span class="token punctuation">.</span><span class="token function">NewTransaction</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">.</span>Nonce<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">.</span>To<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">.</span>Gas<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>GasPrice<span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>如果目标地址为空的话，表示这是一个创建智能合约的交易，调用 NewContractCreation()。否则说明这是一个普通交易，调用 NewTransaction()。不管调用哪个，最终都会生成一个 Transaction 实例，Transaction 类型的定义（core/types/transaction.go）：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Transaction <span class="token keyword">struct</span> <span class="token punctuation">{</span> <span class="token comment">// 主要包含了txdata类型字段，后面三个都是缓存</span>
	data txdata    <span class="token comment">// Consensus contents of a transaction</span>
	time time<span class="token punctuation">.</span>Time <span class="token comment">// Time first seen locally (spam avoidance)</span>

	<span class="token comment">// caches</span>
	hash atomic<span class="token punctuation">.</span>Value
	size atomic<span class="token punctuation">.</span>Value
	from atomic<span class="token punctuation">.</span>Value
<span class="token punctuation">}</span>

<span class="token keyword">type</span> txdata <span class="token keyword">struct</span> <span class="token punctuation">{</span> <span class="token comment">// 没有from地址</span>
	AccountNonce <span class="token builtin">uint64</span>          <span class="token string">`json:&quot;nonce&quot;    gencodec:&quot;required&quot;`</span>
	Price        <span class="token operator">*</span>big<span class="token punctuation">.</span>Int        <span class="token string">`json:&quot;gasPrice&quot; gencodec:&quot;required&quot;`</span>
	GasLimit     <span class="token builtin">uint64</span>          <span class="token string">`json:&quot;gas&quot;      gencodec:&quot;required&quot;`</span>
	Recipient    <span class="token operator">*</span>common<span class="token punctuation">.</span>Address <span class="token string">`json:&quot;to&quot;       rlp:&quot;nil&quot;`</span> <span class="token comment">// nil means contract creation</span>
	Amount       <span class="token operator">*</span>big<span class="token punctuation">.</span>Int        <span class="token string">`json:&quot;value&quot;    gencodec:&quot;required&quot;`</span>
	Payload      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>          <span class="token string">`json:&quot;input&quot;    gencodec:&quot;required&quot;`</span>

	<span class="token comment">// Signature values 3个签名字段</span>
	V <span class="token operator">*</span>big<span class="token punctuation">.</span>Int <span class="token string">`json:&quot;v&quot; gencodec:&quot;required&quot;`</span>
	R <span class="token operator">*</span>big<span class="token punctuation">.</span>Int <span class="token string">`json:&quot;r&quot; gencodec:&quot;required&quot;`</span>
	S <span class="token operator">*</span>big<span class="token punctuation">.</span>Int <span class="token string">`json:&quot;s&quot; gencodec:&quot;required&quot;`</span>

	<span class="token comment">// This is only used when marshaling to JSON. 1个哈希字段</span>
	Hash <span class="token operator">*</span>common<span class="token punctuation">.</span>Hash <span class="token string">`json:&quot;hash&quot; rlp:&quot;-&quot;`</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>可以看到，除了 SendTxArgs 类型的参数值，还有 3 个签名字段和 1 个hash字段。需要注意的是，from 地址并不包含在该结构中。</p> <h2 id="交易签名"><a href="#交易签名" class="header-anchor">#</a> 交易签名</h2> <p>创建完 Transaction 实例以后，会调用 Wallet.SignTx() 进行签名。具体流程参见下图：</p> <p><img src="/assets/img/eth02.a449d809.png" alt="eth02"></p> <p>可以看到，是先通过 Keccak-256 算法计算交易数据的 hash 值，然后结合账户的私钥，通过 ECDSA（Elliptic Curve Digital Signature Algorithm）椭圆曲线数字签名算法生成签名数据。</p> <p>txdata 里只有接收方的地址（Recipient），并没有发送方的地址。这笔交易的发送方的地址可以根据交易数据以及签名推算出来的，参见下图：</p> <p><img src="/assets/img/eth03.b08b7805.png" alt="eth03"></p> <p>Wallet 是一个接口，具体实现在 keyStoreWallet 中（accounts/keystore/wallet.go）：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// SignTx implements accounts.Wallet, attempting to sign the given transaction</span>
<span class="token comment">// with the given account. If the wallet does not wrap this particular account,</span>
<span class="token comment">// an error is returned to avoid account leakage (even though in theory we may</span>
<span class="token comment">// be able to sign via our shared keystore backend).</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>keystoreWallet<span class="token punctuation">)</span> <span class="token function">SignTx</span><span class="token punctuation">(</span>account accounts<span class="token punctuation">.</span>Account<span class="token punctuation">,</span> tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> chainID <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Make sure the requested account is contained within</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>w<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> accounts<span class="token punctuation">.</span>ErrUnknownAccount
	<span class="token punctuation">}</span>
	<span class="token comment">// Account seems valid, request the keystore to sign</span>
	<span class="token keyword">return</span> w<span class="token punctuation">.</span>keystore<span class="token punctuation">.</span><span class="token function">SignTx</span><span class="token punctuation">(</span>account<span class="token punctuation">,</span> tx<span class="token punctuation">,</span> chainID<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>跟踪 KeyStore 的 SignTx() 函数（accounts/keystore/keystore.go）：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// SignTx signs the given transaction with the requested account.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>ks <span class="token operator">*</span>KeyStore<span class="token punctuation">)</span> <span class="token function">SignTx</span><span class="token punctuation">(</span>a accounts<span class="token punctuation">.</span>Account<span class="token punctuation">,</span> tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> chainID <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Look up the key to sign with and abort if it cannot be found</span>
	ks<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 判断账户是否已经解锁</span>
	<span class="token keyword">defer</span> ks<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	unlockedKey<span class="token punctuation">,</span> found <span class="token operator">:=</span> ks<span class="token punctuation">.</span>unlocked<span class="token punctuation">[</span>a<span class="token punctuation">.</span>Address<span class="token punctuation">]</span> <span class="token comment">// 解锁的话可以获取私钥</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrLocked
	<span class="token punctuation">}</span>
	<span class="token comment">// Depending on the presence of the chain ID, sign with EIP155 or homestead</span>
	<span class="token keyword">if</span> chainID <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// 创建签名器，如果要符合EIP155规范的话，需要把chainID传进去，也就是我们的“--networkid”命令行参数</span>
		<span class="token keyword">return</span> types<span class="token punctuation">.</span><span class="token function">SignTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> types<span class="token punctuation">.</span><span class="token function">NewEIP155Signer</span><span class="token punctuation">(</span>chainID<span class="token punctuation">)</span><span class="token punctuation">,</span> unlockedKey<span class="token punctuation">.</span>PrivateKey<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> types<span class="token punctuation">.</span><span class="token function">SignTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> types<span class="token punctuation">.</span>HomesteadSigner<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> unlockedKey<span class="token punctuation">.</span>PrivateKey<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>首先判断账户是否已经解锁，如果已经解锁的话就可以获取它的私钥。</p> <p>然后创建签名器，如果要符合 EIP155 规范的话，需要把 chainID 传进去，也就是 &quot;--networkid&quot; 命令行参数。</p> <p>最后调用一个全局函数 types.SignTx() 完成签名（core/types/transaction_signing.go）：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// SignTx signs the transaction using the given signer and private key</span>
<span class="token keyword">func</span> <span class="token function">SignTx</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>Transaction<span class="token punctuation">,</span> s Signer<span class="token punctuation">,</span> prv <span class="token operator">*</span>ecdsa<span class="token punctuation">.</span>PrivateKey<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Transaction<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	h <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token comment">// 生成交易的hash值</span>
	sig<span class="token punctuation">,</span> err <span class="token operator">:=</span> crypto<span class="token punctuation">.</span><span class="token function">Sign</span><span class="token punctuation">(</span>h<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> prv<span class="token punctuation">)</span> <span class="token comment">// 根据hash值和私钥生成签名</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">WithSignature</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> sig<span class="token punctuation">)</span> <span class="token comment">// 把签名填回Transaction实例</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>主要分为3个步骤：</p> <ul><li>生成交易的 hash 值</li> <li>根据 hash 值和私钥生成签名</li> <li>把签名数据填充到 Transaction 实例中</li></ul> <h3 id="生成交易hash值"><a href="#生成交易hash值" class="header-anchor">#</a> 生成交易hash值</h3> <p>Signer 接口，以 EIP155Signer 的实现为例（core/types/transaction_signing.go）：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Hash returns the hash to be signed by the sender.</span>
<span class="token comment">// It does not uniquely identify the transaction.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s EIP155Signer<span class="token punctuation">)</span> <span class="token function">Hash</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>Transaction<span class="token punctuation">)</span> common<span class="token punctuation">.</span>Hash <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">rlpHash</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
		tx<span class="token punctuation">.</span>data<span class="token punctuation">.</span>AccountNonce<span class="token punctuation">,</span>
		tx<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Price<span class="token punctuation">,</span>
		tx<span class="token punctuation">.</span>data<span class="token punctuation">.</span>GasLimit<span class="token punctuation">,</span>
		tx<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Recipient<span class="token punctuation">,</span>
		tx<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Amount<span class="token punctuation">,</span>
		tx<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Payload<span class="token punctuation">,</span>
		s<span class="token punctuation">.</span>chainId<span class="token punctuation">,</span> <span class="token function">uint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>其中 rlpHash() 先进行 RLP 编码，然后再用 SHA3-256 生成 hash 值。</p> <h3 id="根据hash值和私钥生成签名"><a href="#根据hash值和私钥生成签名" class="header-anchor">#</a> 根据hash值和私钥生成签名</h3> <p>crypto.Sign()函数（crypto/signature_cgo.go）：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Sign calculates an ECDSA signature.</span>
<span class="token comment">//</span>
<span class="token comment">// This function is susceptible to chosen plaintext attacks that can leak</span>
<span class="token comment">// information about the private key that is used for signing. Callers must</span>
<span class="token comment">// be aware that the given digest cannot be chosen by an adversery. Common</span>
<span class="token comment">// solution is to hash any input before calculating the signature.</span>
<span class="token comment">//</span>
<span class="token comment">// The produced signature is in the [R || S || V] format where V is 0 or 1.</span>
<span class="token keyword">func</span> <span class="token function">Sign</span><span class="token punctuation">(</span>digestHash <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> prv <span class="token operator">*</span>ecdsa<span class="token punctuation">.</span>PrivateKey<span class="token punctuation">)</span> <span class="token punctuation">(</span>sig <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>digestHash<span class="token punctuation">)</span> <span class="token operator">!=</span> DigestLength <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;hash is required to be exactly %d bytes (%d)&quot;</span><span class="token punctuation">,</span> DigestLength<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>digestHash<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	seckey <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">PaddedBigBytes</span><span class="token punctuation">(</span>prv<span class="token punctuation">.</span>D<span class="token punctuation">,</span> prv<span class="token punctuation">.</span><span class="token function">Params</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BitSize<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">zeroBytes</span><span class="token punctuation">(</span>seckey<span class="token punctuation">)</span>
	<span class="token keyword">return</span> secp256k1<span class="token punctuation">.</span><span class="token function">Sign</span><span class="token punctuation">(</span>digestHash<span class="token punctuation">,</span> seckey<span class="token punctuation">)</span> <span class="token comment">// 返回的签名是一个字节数组，按R / S / V的顺序排列</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>这里是通过 ECDSA 算法生成签名数据，返回的签名是一个字节数组，按 R / S / V 的顺序排列。</p> <h3 id="填充签名数据"><a href="#填充签名数据" class="header-anchor">#</a> 填充签名数据</h3> <p>最后一步就是把签名数据的这 3 个值填充到 Transaction 结构中了，看一下 WithSignature() 函数（core/types/transaction.go）：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// WithSignature returns a new transaction with the given signature.</span>
<span class="token comment">// This signature needs to be in the [R || S || V] format where V is 0 or 1.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>tx <span class="token operator">*</span>Transaction<span class="token punctuation">)</span> <span class="token function">WithSignature</span><span class="token punctuation">(</span>signer Signer<span class="token punctuation">,</span> sig <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Transaction<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 签名数据的这3个值填充到Transaction结构中</span>
	r<span class="token punctuation">,</span> s<span class="token punctuation">,</span> v<span class="token punctuation">,</span> err <span class="token operator">:=</span> signer<span class="token punctuation">.</span><span class="token function">SignatureValues</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> sig<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	cpy <span class="token operator">:=</span> <span class="token operator">&amp;</span>Transaction<span class="token punctuation">{</span>
		data<span class="token punctuation">:</span> tx<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
		time<span class="token punctuation">:</span> tx<span class="token punctuation">.</span>time<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	cpy<span class="token punctuation">.</span>data<span class="token punctuation">.</span>R<span class="token punctuation">,</span> cpy<span class="token punctuation">.</span>data<span class="token punctuation">.</span>S<span class="token punctuation">,</span> cpy<span class="token punctuation">.</span>data<span class="token punctuation">.</span>V <span class="token operator">=</span> r<span class="token punctuation">,</span> s<span class="token punctuation">,</span> v
	<span class="token keyword">return</span> cpy<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>生成的签名数据是字节数组类型，需要通过 signer.SignatureValues() 函数（）转换成 3 个 big.Int 类型的数据，然后填充到 Transaction 结构的 R / S / V 字段上。可以瞄一眼这个转换函数：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// SignatureValues returns signature values. This signature</span>
<span class="token comment">// needs to be in the [R || S || V] format where V is 0 or 1.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>fs FrontierSigner<span class="token punctuation">)</span> <span class="token function">SignatureValues</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>Transaction<span class="token punctuation">,</span> sig <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>r<span class="token punctuation">,</span> s<span class="token punctuation">,</span> v <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 生成的签名数据是字节数组类型，需要通过signer.SignatureValues()函数转换成3个big.Int类型的数据，然后填充到Transaction结构的R / S / V字段上</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>sig<span class="token punctuation">)</span> <span class="token operator">!=</span> crypto<span class="token punctuation">.</span>SignatureLength <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;wrong size for signature: got %d, want %d&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>sig<span class="token punctuation">)</span><span class="token punctuation">,</span> crypto<span class="token punctuation">.</span>SignatureLength<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	r <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span>sig<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	s <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span>sig<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	v <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>sig<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">27</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> r<span class="token punctuation">,</span> s<span class="token punctuation">,</span> v<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>第 0～31 字节是 R，第 32～63 字节是 S，第 64 位加上 27 就可以得到 V。</p> <h2 id="提交交易"><a href="#提交交易" class="header-anchor">#</a> 提交交易</h2> <p>签完名后，需要调用 SubmitTransaction() 函数提交到交易缓冲池 txpool 中。</p> <p>先看下 TxPool 类型（core/tx_pool.go）的几个字段：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// TxPool contains all currently known transactions. Transactions</span>
<span class="token comment">// enter the pool when they are received from the network or submitted</span>
<span class="token comment">// locally. They exit the pool when they are included in the blockchain.</span>
<span class="token comment">//</span>
<span class="token comment">// The pool separates processable transactions (which can be applied to the</span>
<span class="token comment">// current state) and future transactions. Transactions move between those</span>
<span class="token comment">// two states over time as they are received and processed.</span>
<span class="token keyword">type</span> TxPool <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	config      TxPoolConfig
	chainconfig <span class="token operator">*</span>params<span class="token punctuation">.</span>ChainConfig
	chain       blockChain
	gasPrice    <span class="token operator">*</span>big<span class="token punctuation">.</span>Int
	txFeed      event<span class="token punctuation">.</span>Feed
	scope       event<span class="token punctuation">.</span>SubscriptionScope
	signer      types<span class="token punctuation">.</span>Signer
	mu          sync<span class="token punctuation">.</span>RWMutex

	istanbul <span class="token builtin">bool</span> <span class="token comment">// Fork indicator whether we are in the istanbul stage.</span>

	currentState  <span class="token operator">*</span>state<span class="token punctuation">.</span>StateDB <span class="token comment">// Current state in the blockchain head</span>
	pendingNonces <span class="token operator">*</span>txNoncer      <span class="token comment">// Pending state tracking virtual nonces</span>
	currentMaxGas <span class="token builtin">uint64</span>         <span class="token comment">// Current gas limit for transaction caps</span>

	locals  <span class="token operator">*</span>accountSet <span class="token comment">// Set of local transaction to exempt from eviction rules</span>
	journal <span class="token operator">*</span>txJournal  <span class="token comment">// Journal of local transaction to back up to disk</span>

	pending <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span><span class="token operator">*</span>txList   <span class="token comment">// All currently processable transactions 当前所有可被处理的交易列表</span>
	queue   <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span><span class="token operator">*</span>txList   <span class="token comment">// Queued but non-processable transactions 所有不可被处理、也就是新加入进来的交易</span>
	beats   <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span>time<span class="token punctuation">.</span>Time <span class="token comment">// Last heartbeat from each known account</span>
	all     <span class="token operator">*</span>txLookup                    <span class="token comment">// All transactions to allow lookups</span>
	priced  <span class="token operator">*</span>txPricedList                <span class="token comment">// All transactions sorted by price</span>

	chainHeadCh     <span class="token keyword">chan</span> ChainHeadEvent
	chainHeadSub    event<span class="token punctuation">.</span>Subscription
	reqResetCh      <span class="token keyword">chan</span> <span class="token operator">*</span>txpoolResetRequest
	reqPromoteCh    <span class="token keyword">chan</span> <span class="token operator">*</span>accountSet
	queueTxEventCh  <span class="token keyword">chan</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction
	reorgDoneCh     <span class="token keyword">chan</span> <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	reorgShutdownCh <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment">// requests shutdown of scheduleReorgLoop</span>
	wg              sync<span class="token punctuation">.</span>WaitGroup <span class="token comment">// tracks loop, scheduleReorgLoop</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>pending 字段中包含了当前所有可被处理的交易列表，而 queue 字段中包含了所有不可被处理、也就是新加入进来的交易。它们是按账号地址来组织的，每个地址对应一个txList，具体内部结构参见下图：</p> <p><img src="/assets/img/eth04.07da02a3.png" alt="eth04"></p> <p>可以看到 txList 内部包含一个 txSortedMap 结构，实现按 nonce 排序，其内部维护了两张表：</p> <ul><li>一张是包含了所有 Transaction 的 map，key 是 Transaction 的 nonce 值，越新的交易，nonce值越高。</li> <li>还有一张表是一个数组，包含了所有 nonce 值，其内部是进行过堆排序的（小顶堆），nonce 值按照从大到小排列。每次调用 heap.Pop() 时会取出最小的 nonce 值，也就是最老的交易。</li></ul> <p>all 字段中包含了所有的交易列表，以交易的 hash 作为 key。</p> <p>priced 字段则是把 all 中的交易列表按照 gas price 从大到小排列，如果 gas price 一样，则按照交易的 nonce 值从小到大排列。最终的目标是每次取出 gas price 最大、nonce 最小的交易。</p> <p><img src="/assets/img/eth05.6d3c4fda.png" alt="eth05"></p> <p>我们提交交易的目标是：<strong>先把交易放入 queue 中记录在案，然后再从 queue 中选一部分放入 pending 中进行处理。如果发现 txpool 满了，则依据 priced 中的排序，剔除低油价的交易</strong>。</p> <p>另外，如果是本地（local）提交的交易，默认情况下会尽可能地保证被放入 txpool 中，除非显式关闭该配置。</p> <p>接着我们看一下txpool的默认配置：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// TxPoolConfig are the configuration parameters of the transaction pool.</span>
<span class="token keyword">type</span> TxPoolConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Locals    <span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Address <span class="token comment">// Addresses that should be treated by default as local</span>
	NoLocals  <span class="token builtin">bool</span>             <span class="token comment">// Whether local transaction handling should be disabled</span>
	Journal   <span class="token builtin">string</span>           <span class="token comment">// Journal of local transactions to survive node restarts</span>
	Rejournal time<span class="token punctuation">.</span>Duration    <span class="token comment">// Time interval to regenerate the local transaction journal</span>

	PriceLimit <span class="token builtin">uint64</span> <span class="token comment">// Minimum gas price to enforce for acceptance into the pool</span>
	PriceBump  <span class="token builtin">uint64</span> <span class="token comment">// Minimum price bump percentage to replace an already existing transaction (nonce)</span>

	AccountSlots <span class="token builtin">uint64</span> <span class="token comment">// Number of executable transaction slots guaranteed per account</span>
	GlobalSlots  <span class="token builtin">uint64</span> <span class="token comment">// Maximum number of executable transaction slots for all accounts</span>
	AccountQueue <span class="token builtin">uint64</span> <span class="token comment">// Maximum number of non-executable transaction slots permitted per account</span>
	GlobalQueue  <span class="token builtin">uint64</span> <span class="token comment">// Maximum number of non-executable transaction slots for all accounts</span>

	Lifetime time<span class="token punctuation">.</span>Duration <span class="token comment">// Maximum amount of time non-executable transaction are queued</span>
<span class="token punctuation">}</span>

<span class="token comment">// DefaultTxPoolConfig contains the default configurations for the transaction</span>
<span class="token comment">// pool.</span>
<span class="token keyword">var</span> DefaultTxPoolConfig <span class="token operator">=</span> TxPoolConfig<span class="token punctuation">{</span>
	Journal<span class="token punctuation">:</span>   <span class="token string">&quot;transactions.rlp&quot;</span><span class="token punctuation">,</span>
	Rejournal<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">,</span>

	PriceLimit<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 允许进入txpool的最低gas price，默认1 Gwei</span>
	PriceBump<span class="token punctuation">:</span>  <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 如果出现两个nonce相同的交易，gas price的差值超过该阈值则用新交易替换老交易</span>

	AccountSlots<span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token comment">// pending中每个账户存储的交易数的阈值，超过这个数量可能会被认为是垃圾交易或者是攻击者，多余交易会被丢弃</span>
	GlobalSlots<span class="token punctuation">:</span>  <span class="token number">4096</span><span class="token punctuation">,</span> <span class="token comment">// pending列表的最大长度，默认4096笔</span>
	AccountQueue<span class="token punctuation">:</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token comment">// queue中每个账户允许存储的最大交易数，超过会被丢弃，默认64笔</span>
	GlobalQueue<span class="token punctuation">:</span>  <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token comment">// queue列表的最大长度，默认1024笔</span>

	Lifetime<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><ul><li>GlobalSlots：pending 列表的最大长度，默认 4096 笔</li> <li>AccountSlots：pending 中每个账户存储的交易数的阈值，超过这个数量可能会被认为是垃圾交易或者是攻击者，多余交易可能被丢弃</li> <li>GlobalQueue：queue 列表的最大长度，默认 1024 笔</li> <li>AccountQueue：queue 中每个账户允许存储的最大交易数，超过会被丢弃，默认 64 笔</li> <li>PriceLimit：允许进入 txpool 的最低 gas price，默认 1 Gwei</li> <li>PriceBump：如果出现两个 nonce 相同的交易，gas price 的差值超过该阈值则用新交易替换老交易</li></ul> <p>现在回来分析 SubmitTransaction() 函数（internal/ethapi/api.go）：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// SubmitTransaction is a helper function that submits tx to txPool and logs a message.</span>
<span class="token keyword">func</span> <span class="token function">SubmitTransaction</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> b Backend<span class="token punctuation">,</span> tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Backend在eth service初始化时创建，实现在eth/api_backend.go中</span>
	<span class="token comment">// If the transaction fee cap is already specified, ensure the</span>
	<span class="token comment">// fee of the given transaction is _reasonable_.</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">checkTxFee</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">RPCTxFeeCap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">SendTx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> tx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> tx<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		signer <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">MakeSigner</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">ChainConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">CurrentBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		from<span class="token punctuation">,</span> err <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">Sender</span><span class="token punctuation">(</span>signer<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>
		addr <span class="token operator">:=</span> crypto<span class="token punctuation">.</span><span class="token function">CreateAddress</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Submitted contract creation&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fullhash&quot;</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;contract&quot;</span><span class="token punctuation">,</span> addr<span class="token punctuation">.</span><span class="token function">Hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Submitted transaction&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fullhash&quot;</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;recipient&quot;</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>这里有一个 Backend 参数，是在 eth Service 初始化时创建的，实现了Backend 接口（ethapi/backend.go）的 EthApiBackend 类型（eth/api_backend.go）。这里先调用了 SendTx() 函数（eth/api_backend.go）提交交易，然后如果发现目标地址为空，表明这是一个创建智能合约的交易，会创建合约地址。</p> <h3 id="提交交易到txpool"><a href="#提交交易到txpool" class="header-anchor">#</a> 提交交易到txpool</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>EthAPIBackend<span class="token punctuation">)</span> <span class="token function">SendTx</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> signedTx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> b<span class="token punctuation">.</span>eth<span class="token punctuation">.</span>txPool<span class="token punctuation">.</span><span class="token function">AddLocal</span><span class="token punctuation">(</span>signedTx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>继续跟踪 TxPool 的 AddLocal() 函数、AddLocals() 函数、addTxs() 函数（core/tx_pool.go）：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// AddLocal enqueues a single local transaction into the pool if it is valid. This is</span>
<span class="token comment">// a convenience wrapper aroundd AddLocals.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">AddLocal</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	errs <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">AddLocals</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">{</span>tx<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> errs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// AddLocals enqueues a batch of transactions into the pool if they are valid, marking the</span>
<span class="token comment">// senders as a local ones, ensuring they go around the local pricing constraints.</span>
<span class="token comment">//</span>
<span class="token comment">// This method is used to add transactions from the RPC API and performs synchronous pool</span>
<span class="token comment">// reorganization and event propagation.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">AddLocals</span><span class="token punctuation">(</span>txs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> pool<span class="token punctuation">.</span><span class="token function">addTxs</span><span class="token punctuation">(</span>txs<span class="token punctuation">,</span> <span class="token operator">!</span>pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>NoLocals<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// addTxs attempts to queue a batch of transactions if they are valid.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">addTxs</span><span class="token punctuation">(</span>txs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> local<span class="token punctuation">,</span> sync <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// Filter out known ones without obtaining the pool lock or recovering signatures</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		errs <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span><span class="token punctuation">)</span>
		news <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> txs <span class="token punctuation">{</span>
		<span class="token comment">// If the transaction is known, pre-set the error slot</span>
		<span class="token keyword">if</span> pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			errs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> ErrAlreadyKnown
			knownTxMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// Exclude transactions with invalid signatures as soon as</span>
		<span class="token comment">// possible and cache senders in transactions before</span>
		<span class="token comment">// obtaining lock</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">Sender</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>signer<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			errs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> ErrInvalidSender
			invalidTxMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// Accumulate all unknown transactions for deeper processing</span>
		news <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>news<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>news<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errs
	<span class="token punctuation">}</span>

	<span class="token comment">// Process all the new transaction and merge any errors into the original slice</span>
	pool<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	newErrs<span class="token punctuation">,</span> dirtyAddrs <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">addTxsLocked</span><span class="token punctuation">(</span>news<span class="token punctuation">,</span> local<span class="token punctuation">)</span> <span class="token comment">// 将有效交易加入交易池</span>
	pool<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> nilSlot <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token keyword">range</span> newErrs <span class="token punctuation">{</span>
		<span class="token keyword">for</span> errs<span class="token punctuation">[</span>nilSlot<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			nilSlot<span class="token operator">++</span>
		<span class="token punctuation">}</span>
		errs<span class="token punctuation">[</span>nilSlot<span class="token punctuation">]</span> <span class="token operator">=</span> err
		nilSlot<span class="token operator">++</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Reorg the pool internals if needed and return</span>
	done <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">requestPromoteExecutables</span><span class="token punctuation">(</span>dirtyAddrs<span class="token punctuation">)</span> <span class="token comment">// 把交易从queue提升到pending中</span>
	<span class="token keyword">if</span> sync <span class="token punctuation">{</span>
		<span class="token operator">&lt;-</span>done
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> errs
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>这里有两个主要函数：addTxsLocked() 和 requestPromoteExecuteables()。</p> <p>addTxsLocked() 函数将一批有效交易加入到 queue 列表中，requestPromoteExecuteables() 则会从 queue 中选取一些交易放入 pending 列表中等待执行。下面分别讨论这两个函数。</p> <h4 id="addtxslocked"><a href="#addtxslocked" class="header-anchor">#</a> addTxsLocked()</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// addTxsLocked attempts to queue a batch of transactions if they are valid.</span>
<span class="token comment">// The transaction pool lock must be held.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">addTxsLocked</span><span class="token punctuation">(</span>txs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> local <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token operator">*</span>accountSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	dirty <span class="token operator">:=</span> <span class="token function">newAccountSet</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>signer<span class="token punctuation">)</span>
	errs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> txs <span class="token punctuation">{</span>
		replaced<span class="token punctuation">,</span> err <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> local<span class="token punctuation">)</span>
		errs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> err
		<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>replaced <span class="token punctuation">{</span>
			dirty<span class="token punctuation">.</span><span class="token function">addTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	validTxMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>dirty<span class="token punctuation">.</span>accounts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> errs<span class="token punctuation">,</span> dirty
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>跟踪调用的 add() 函数，判断是否应该把当前交易加入到 queue 列表中：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// add validates a transaction and inserts it into the non-executable queue for later</span>
<span class="token comment">// pending promotion and execution. If the transaction is a replacement for an already</span>
<span class="token comment">// pending or queued one, it overwrites the previous transaction if its price is higher.</span>
<span class="token comment">//</span>
<span class="token comment">// If a newly added transaction is marked as local, its sending account will be</span>
<span class="token comment">// whitelisted, preventing any associated transaction from being dropped out of the pool</span>
<span class="token comment">// due to pricing constraints.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">add</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> local <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>replaced <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// If the transaction is already known, discard it</span>
	hash <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// 判断是否已经在交易池中，在的话直接退出</span>
		log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">&quot;Discarding already known transaction&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hash&quot;</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
		knownTxMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ErrAlreadyKnown
	<span class="token punctuation">}</span>
	<span class="token comment">// If the transaction fails basic validation, discard it</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">validateTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// 验证交易有效性</span>
		log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">&quot;Discarding invalid transaction&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hash&quot;</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">&quot;err&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		invalidTxMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token comment">// If the transaction pool is full, discard underpriced transactions</span>
	<span class="token keyword">if</span> <span class="token function">uint64</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalSlots<span class="token operator">+</span>pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalQueue <span class="token punctuation">{</span> <span class="token comment">// 交易池满的话，剔除低gas交易</span>
		<span class="token comment">// If the new transaction is underpriced, don't accept it</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>local <span class="token operator">&amp;&amp;</span> pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Underpriced</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> pool<span class="token punctuation">.</span>locals<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 低于最低价直接丢弃该交易</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">&quot;Discarding underpriced transaction&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hash&quot;</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">&quot;price&quot;</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			underpricedTxMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ErrUnderpriced
		<span class="token punctuation">}</span>
		<span class="token comment">// New transaction is better than our worse ones, make room for it</span>
		drop <span class="token operator">:=</span> pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Discard</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Slots</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">int</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalSlots<span class="token operator">+</span>pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalQueue<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">numSlots</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">,</span> pool<span class="token punctuation">.</span>locals<span class="token punctuation">)</span> <span class="token comment">// 高于最低价，则从交易池中剔除低价交易</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> drop <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">&quot;Discarding freshly underpriced transaction&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hash&quot;</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;price&quot;</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			underpricedTxMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span><span class="token function">removeTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Try to replace an existing transaction in the pending pool</span>
	from<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">Sender</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>signer<span class="token punctuation">,</span> tx<span class="token punctuation">)</span> <span class="token comment">// already validated</span>
	<span class="token keyword">if</span> list <span class="token operator">:=</span> pool<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>from<span class="token punctuation">]</span><span class="token punctuation">;</span> list <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> list<span class="token punctuation">.</span><span class="token function">Overlaps</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Overlaps()判断pending列表中是否包含相同nonce的交易</span>
		<span class="token comment">// Nonce already pending, check if required price bump is met</span>
		inserted<span class="token punctuation">,</span> old <span class="token operator">:=</span> list<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PriceBump<span class="token punctuation">)</span> <span class="token comment">// 判断是否超过PriceBump</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>inserted <span class="token punctuation">{</span> <span class="token comment">// 没超过，丢弃</span>
			pendingDiscardMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ErrReplaceUnderpriced
		<span class="token punctuation">}</span>
		<span class="token comment">// New transaction is better, replace old one</span>
		<span class="token keyword">if</span> old <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// 超过了，替换</span>
			pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			pendingReplaceMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span><span class="token function">journalTx</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span><span class="token function">queueTxEvent</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">&quot;Pooled new executable transaction&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hash&quot;</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">&quot;from&quot;</span><span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token string">&quot;to&quot;</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token comment">// Successful promotion, bump the heartbeat</span>
		pool<span class="token punctuation">.</span>beats<span class="token punctuation">[</span>from<span class="token punctuation">]</span> <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> old <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// New transaction isn't replacing a pending one, push into queue</span>
	replaced<span class="token punctuation">,</span> err <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">enqueueTx</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> tx<span class="token punctuation">)</span> <span class="token comment">// 之前的检查没有问题，就加入到queue</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token comment">// Mark local addresses and journal local transactions</span>
	<span class="token keyword">if</span> local <span class="token punctuation">{</span> <span class="token comment">// 如果账户是本地的，就把它加到一个白名单里，默认保证本地交易优先进交易池</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>pool<span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Setting new local account&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> from<span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> local <span class="token operator">||</span> pool<span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		localGauge<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	pool<span class="token punctuation">.</span><span class="token function">journalTx</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>

	log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">&quot;Pooled new future transaction&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hash&quot;</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">&quot;from&quot;</span><span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token string">&quot;to&quot;</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> replaced<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br></div></div><p>验证交易有效性部分调用了 validateTx() 函数，主要进行以下几个方面的检查：</p> <ul><li>数据量必须 &lt; 32KB</li> <li>交易金额必须非负（&gt;=0）</li> <li>交易的 gas limit 必须低于 block 的 gas limit</li> <li>签名数据必须有效，能够解析出发送者地址</li> <li>交易的 gas price 必须高于 pool 设定的最低 gas price（除非是本地交易）</li> <li>交易的 nonce 值必须高于当前链上该账户的 nonce 值（低于则说明这笔交易已经被打包过了）</li> <li>当前账户余额必须大于 &quot;交易金额 + gasprice * gaslimit&quot;</li> <li>交易的 gas limit 必须大于对应数据量所需的最低 gas 水平</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// validateTx checks whether a transaction is valid according to the consensus</span>
<span class="token comment">// rules and adheres to some heuristic limits of the local node (price and size).</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">validateTx</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> local <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// Reject transactions over defined size to prevent DOS attacks</span>
	<span class="token keyword">if</span> <span class="token function">uint64</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> txMaxSize <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrOversizedData
	<span class="token punctuation">}</span>
	<span class="token comment">// Transactions can't be negative. This may never happen using RLP decoded</span>
	<span class="token comment">// transactions but may occur if you create a transaction using the RPC.</span>
	<span class="token keyword">if</span> tx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrNegativeValue
	<span class="token punctuation">}</span>
	<span class="token comment">// Ensure the transaction doesn't exceed the current block limit gas.</span>
	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>currentMaxGas <span class="token operator">&lt;</span> tx<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrGasLimit
	<span class="token punctuation">}</span>
	<span class="token comment">// Make sure the transaction is signed properly</span>
	from<span class="token punctuation">,</span> err <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">Sender</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>signer<span class="token punctuation">,</span> tx<span class="token punctuation">)</span> <span class="token comment">// 通过签名和交易数据得到发送方地址</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrInvalidSender
	<span class="token punctuation">}</span>
	<span class="token comment">// Drop non-local transactions under our own minimal accepted gas price</span>
	local <span class="token operator">=</span> local <span class="token operator">||</span> pool<span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token comment">// account may be local even if the transaction arrived from the network</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>local <span class="token operator">&amp;&amp;</span> tx<span class="token punctuation">.</span><span class="token function">GasPriceIntCmp</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>gasPrice<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrUnderpriced
	<span class="token punctuation">}</span>
	<span class="token comment">// Ensure the transaction adheres to nonce ordering</span>
	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>currentState<span class="token punctuation">.</span><span class="token function">GetNonce</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">&gt;</span> tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrNonceTooLow
	<span class="token punctuation">}</span>
	<span class="token comment">// Transactor should have enough funds to cover the costs</span>
	<span class="token comment">// cost == V + GP * GL</span>
	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>currentState<span class="token punctuation">.</span><span class="token function">GetBalance</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Cost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrInsufficientFunds
	<span class="token punctuation">}</span>
	<span class="token comment">// Ensure the transaction has more gas than the basic tx fee.</span>
	intrGas<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">IntrinsicGas</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> pool<span class="token punctuation">.</span>istanbul<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> tx<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> intrGas <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrIntrinsicGas
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h4 id="requestpromoteexecuteables"><a href="#requestpromoteexecuteables" class="header-anchor">#</a> requestPromoteExecuteables()</h4> <p><mark>需要搞明白和 promoteExecuteables() 函数的关系</mark></p> <h3 id="创建智能合约地址"><a href="#创建智能合约地址" class="header-anchor">#</a> 创建智能合约地址</h3> <p>SubmitTransaction() 函数（internal/ethapi/api.go）中 <code>addr := crypto.CreateAddress(from, tx.Nonce())</code> 中的 CreateAddress() 函数（crypto/crypto.go)参数是发送方地址和交易的 nonce 值：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// CreateAddress creates an ethereum address given the bytes and the nonce</span>
<span class="token keyword">func</span> <span class="token function">CreateAddress</span><span class="token punctuation">(</span>b common<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> nonce <span class="token builtin">uint64</span><span class="token punctuation">)</span> common<span class="token punctuation">.</span>Address <span class="token punctuation">{</span>
	data<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> rlp<span class="token punctuation">.</span><span class="token function">EncodeToBytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>b<span class="token punctuation">,</span> nonce<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> common<span class="token punctuation">.</span><span class="token function">BytesToAddress</span><span class="token punctuation">(</span><span class="token function">Keccak256</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>先对两个参数进行 RLP 编码，然后计算 hash 值，取后 20 位作为合约地址。</p> <p>至此，提交交易部分的代码就分析完了。</p> <h2 id="广播交易"><a href="#广播交易" class="header-anchor">#</a> 广播交易</h2> <p>交易提交到 txpool 中后，还需要广播出去，一方面通知 EVM 执行该交易，另一方面要把交易信息广播给其他结点。promoteTx() 函数（crypto/tx_pool.go）将 1 笔交易提交到 pending 列表：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// promoteTx adds a transaction to the pending (processable) list of transactions</span>
<span class="token comment">// and returns whether it was inserted or an older was better.</span>
<span class="token comment">//</span>
<span class="token comment">// Note, this method assumes the pool lock is held!</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">promoteTx</span><span class="token punctuation">(</span>addr common<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token comment">// Try to insert the transaction into the pending queue</span>
	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		pool<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newTxList</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	list <span class="token operator">:=</span> pool<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>addr<span class="token punctuation">]</span>

	inserted<span class="token punctuation">,</span> old <span class="token operator">:=</span> list<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PriceBump<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>inserted <span class="token punctuation">{</span>
		<span class="token comment">// An older transaction was better, discard this</span>
		pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		pendingDiscardMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Otherwise discard any previous transaction and mark this</span>
	<span class="token keyword">if</span> old <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		pendingReplaceMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// Nothing was replaced, bump the pending counter</span>
		pendingGauge<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Failsafe to work around direct pending inserts (tests)</span>
	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Set the potentially new pending nonce and notify any subsystems of the new tx</span>
	pool<span class="token punctuation">.</span>pendingNonces<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 更新账户的nonce值</span>

	<span class="token comment">// Successful promotion, bump the heartbeat</span>
	pool<span class="token punctuation">.</span>beats<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 更新最后一次心跳时间</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>runReorg() 函数（crypto/tx_pool.go）在最后发送一个 NewTxsEvent 事件。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runReorg runs reset and promoteExecutables on behalf of scheduleReorgLoop.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">runReorg</span><span class="token punctuation">(</span>done <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> reset <span class="token operator">*</span>txpoolResetRequest<span class="token punctuation">,</span> dirtyAccounts <span class="token operator">*</span>accountSet<span class="token punctuation">,</span> events <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span><span class="token operator">*</span>txSortedMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span>

	<span class="token keyword">var</span> promoteAddrs <span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Address
	<span class="token keyword">if</span> dirtyAccounts <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> reset <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// Only dirty accounts need to be promoted, unless we're resetting.</span>
		<span class="token comment">// For resets, all addresses in the tx queue will be promoted and</span>
		<span class="token comment">// the flatten operation can be avoided.</span>
		promoteAddrs <span class="token operator">=</span> dirtyAccounts<span class="token punctuation">.</span><span class="token function">flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	pool<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> reset <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// Reset from the old head to the new, rescheduling any reorged transactions</span>
		pool<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>reset<span class="token punctuation">.</span>oldHead<span class="token punctuation">,</span> reset<span class="token punctuation">.</span>newHead<span class="token punctuation">)</span>

		<span class="token comment">// Nonces were reset, discard any events that became stale</span>
		<span class="token keyword">for</span> addr <span class="token operator">:=</span> <span class="token keyword">range</span> events <span class="token punctuation">{</span>
			events<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Forward</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>pendingNonces<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> events<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token function">delete</span><span class="token punctuation">(</span>events<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// Reset needs promote for all addresses</span>
		promoteAddrs <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> addr <span class="token operator">:=</span> <span class="token keyword">range</span> pool<span class="token punctuation">.</span>queue <span class="token punctuation">{</span>
			promoteAddrs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>promoteAddrs<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Check for pending transactions for every account that sent new ones</span>
	promoted <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">promoteExecutables</span><span class="token punctuation">(</span>promoteAddrs<span class="token punctuation">)</span>

	<span class="token comment">// If a new block appeared, validate the pool of pending transactions. This will</span>
	<span class="token comment">// remove any transaction that has been included in the block or was invalidated</span>
	<span class="token comment">// because of another transaction (e.g. higher gas price).</span>
	<span class="token keyword">if</span> reset <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		pool<span class="token punctuation">.</span><span class="token function">demoteUnexecutables</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Ensure pool.queue and pool.pending sizes stay within the configured limits.</span>
	pool<span class="token punctuation">.</span><span class="token function">truncatePending</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	pool<span class="token punctuation">.</span><span class="token function">truncateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Update all accounts to the latest known pending nonce</span>
	<span class="token keyword">for</span> addr<span class="token punctuation">,</span> list <span class="token operator">:=</span> <span class="token keyword">range</span> pool<span class="token punctuation">.</span>pending <span class="token punctuation">{</span>
		highestPending <span class="token operator">:=</span> list<span class="token punctuation">.</span><span class="token function">LastElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span>pendingNonces<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> highestPending<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	pool<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Notify subsystems for newly added transactions</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> promoted <span class="token punctuation">{</span>
		addr<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">Sender</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>signer<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> events<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			events<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newTxSortedMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		events<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> txs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> set <span class="token operator">:=</span> <span class="token keyword">range</span> events <span class="token punctuation">{</span>
			txs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>txs<span class="token punctuation">,</span> set<span class="token punctuation">.</span><span class="token function">Flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		pool<span class="token punctuation">.</span>txFeed<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>NewTxsEvent<span class="token punctuation">{</span>txs<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 发送一个NewTxsEvent事件</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>外部可以通过 SubscribeNewTxsEvent() 函数订阅该事件。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// SubscribeNewTxsEvent registers a subscription of NewTxsEvent and</span>
<span class="token comment">// starts sending event to the given channel.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">SubscribeNewTxsEvent</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span><span class="token operator">&lt;-</span> NewTxsEvent<span class="token punctuation">)</span> event<span class="token punctuation">.</span>Subscription <span class="token punctuation">{</span> <span class="token comment">// 外部通过这个函数订阅NewTxsEvent事件</span>
	<span class="token keyword">return</span> pool<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">Track</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>txFeed<span class="token punctuation">.</span><span class="token function">Subscribe</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>搜索一下这个函数，就可以知道哪些组件订阅了该事件。</p> <h3 id="执行交易"><a href="#执行交易" class="header-anchor">#</a> 执行交易</h3> <p>第一个订阅的地方位于 miner/worker.go：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">newWorker</span><span class="token punctuation">(</span>config <span class="token operator">*</span>Config<span class="token punctuation">,</span> chainConfig <span class="token operator">*</span>params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> engine consensus<span class="token punctuation">.</span>Engine<span class="token punctuation">,</span> eth Backend<span class="token punctuation">,</span> mux <span class="token operator">*</span>event<span class="token punctuation">.</span>TypeMux<span class="token punctuation">,</span> isLocalBlock <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> init <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>worker <span class="token punctuation">{</span>
	worker <span class="token operator">:=</span> <span class="token operator">&amp;</span>worker<span class="token punctuation">{</span>
		config<span class="token punctuation">:</span>             config<span class="token punctuation">,</span>
		chainConfig<span class="token punctuation">:</span>        chainConfig<span class="token punctuation">,</span>
		engine<span class="token punctuation">:</span>             engine<span class="token punctuation">,</span>
		eth<span class="token punctuation">:</span>                eth<span class="token punctuation">,</span>
		mux<span class="token punctuation">:</span>                mux<span class="token punctuation">,</span>
		chain<span class="token punctuation">:</span>              eth<span class="token punctuation">.</span><span class="token function">BlockChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		isLocalBlock<span class="token punctuation">:</span>       isLocalBlock<span class="token punctuation">,</span>
		localUncles<span class="token punctuation">:</span>        <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">)</span><span class="token punctuation">,</span>
		remoteUncles<span class="token punctuation">:</span>       <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">)</span><span class="token punctuation">,</span>
		unconfirmed<span class="token punctuation">:</span>        <span class="token function">newUnconfirmedBlocks</span><span class="token punctuation">(</span>eth<span class="token punctuation">.</span><span class="token function">BlockChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> miningLogAtDepth<span class="token punctuation">)</span><span class="token punctuation">,</span>
		pendingTasks<span class="token punctuation">:</span>       <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>task<span class="token punctuation">)</span><span class="token punctuation">,</span>
		txsCh<span class="token punctuation">:</span>              <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> core<span class="token punctuation">.</span>NewTxsEvent<span class="token punctuation">,</span> txChanSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
		chainHeadCh<span class="token punctuation">:</span>        <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> core<span class="token punctuation">.</span>ChainHeadEvent<span class="token punctuation">,</span> chainHeadChanSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
		chainSideCh<span class="token punctuation">:</span>        <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> core<span class="token punctuation">.</span>ChainSideEvent<span class="token punctuation">,</span> chainSideChanSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
		newWorkCh<span class="token punctuation">:</span>          <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>newWorkReq<span class="token punctuation">)</span><span class="token punctuation">,</span>
		taskCh<span class="token punctuation">:</span>             <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>task<span class="token punctuation">)</span><span class="token punctuation">,</span>
		resultCh<span class="token punctuation">:</span>           <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">,</span> resultQueueSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
		exitCh<span class="token punctuation">:</span>             <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		startCh<span class="token punctuation">:</span>            <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		resubmitIntervalCh<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span><span class="token punctuation">,</span>
		resubmitAdjustCh<span class="token punctuation">:</span>   <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>intervalAdjust<span class="token punctuation">,</span> resubmitAdjustChanSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Subscribe NewTxsEvent for tx pool</span>
	worker<span class="token punctuation">.</span>txsSub <span class="token operator">=</span> eth<span class="token punctuation">.</span><span class="token function">TxPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SubscribeNewTxsEvent</span><span class="token punctuation">(</span>worker<span class="token punctuation">.</span>txsCh<span class="token punctuation">)</span> <span class="token comment">// 订阅新交易事件</span>
	<span class="token comment">// Subscribe events for blockchain</span>
	worker<span class="token punctuation">.</span>chainHeadSub <span class="token operator">=</span> eth<span class="token punctuation">.</span><span class="token function">BlockChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SubscribeChainHeadEvent</span><span class="token punctuation">(</span>worker<span class="token punctuation">.</span>chainHeadCh<span class="token punctuation">)</span>
	worker<span class="token punctuation">.</span>chainSideSub <span class="token operator">=</span> eth<span class="token punctuation">.</span><span class="token function">BlockChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SubscribeChainSideEvent</span><span class="token punctuation">(</span>worker<span class="token punctuation">.</span>chainSideCh<span class="token punctuation">)</span>

	<span class="token comment">// Sanitize recommit interval if the user-specified one is too short.</span>
	recommit <span class="token operator">:=</span> worker<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Recommit
	<span class="token keyword">if</span> recommit <span class="token operator">&lt;</span> minRecommitInterval <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">&quot;Sanitizing miner recommit interval&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;provided&quot;</span><span class="token punctuation">,</span> recommit<span class="token punctuation">,</span> <span class="token string">&quot;updated&quot;</span><span class="token punctuation">,</span> minRecommitInterval<span class="token punctuation">)</span>
		recommit <span class="token operator">=</span> minRecommitInterval
	<span class="token punctuation">}</span>

	<span class="token keyword">go</span> worker<span class="token punctuation">.</span><span class="token function">mainLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> worker<span class="token punctuation">.</span><span class="token function">newWorkLoop</span><span class="token punctuation">(</span>recommit<span class="token punctuation">)</span>
	<span class="token keyword">go</span> worker<span class="token punctuation">.</span><span class="token function">resultLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> worker<span class="token punctuation">.</span><span class="token function">taskLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Submit first work to initialize pending state.</span>
	<span class="token keyword">if</span> init <span class="token punctuation">{</span>
		worker<span class="token punctuation">.</span>startCh <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> worker
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>开启了一个 goroutine mainLoop() 函数接收 NewTxsEvent。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// mainLoop is a standalone goroutine to regenerate the sealing task based on the received event.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>worker<span class="token punctuation">)</span> <span class="token function">mainLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> w<span class="token punctuation">.</span>txsSub<span class="token punctuation">.</span><span class="token function">Unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> w<span class="token punctuation">.</span>chainHeadSub<span class="token punctuation">.</span><span class="token function">Unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> w<span class="token punctuation">.</span>chainSideSub<span class="token punctuation">.</span><span class="token function">Unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> req <span class="token operator">:=</span> <span class="token operator">&lt;-</span>w<span class="token punctuation">.</span>newWorkCh<span class="token punctuation">:</span>
			w<span class="token punctuation">.</span><span class="token function">commitNewWork</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>interrupt<span class="token punctuation">,</span> req<span class="token punctuation">.</span>noempty<span class="token punctuation">,</span> req<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span>

		<span class="token keyword">case</span> ev <span class="token operator">:=</span> <span class="token operator">&lt;-</span>w<span class="token punctuation">.</span>chainSideCh<span class="token punctuation">:</span>
			<span class="token comment">// Short circuit for duplicate side blocks</span>
			<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> exist <span class="token operator">:=</span> w<span class="token punctuation">.</span>localUncles<span class="token punctuation">[</span>ev<span class="token punctuation">.</span>Block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> exist <span class="token punctuation">{</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> exist <span class="token operator">:=</span> w<span class="token punctuation">.</span>remoteUncles<span class="token punctuation">[</span>ev<span class="token punctuation">.</span>Block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> exist <span class="token punctuation">{</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// Add side block to possible uncle block set depending on the author.</span>
			<span class="token keyword">if</span> w<span class="token punctuation">.</span>isLocalBlock <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> w<span class="token punctuation">.</span><span class="token function">isLocalBlock</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>Block<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				w<span class="token punctuation">.</span>localUncles<span class="token punctuation">[</span>ev<span class="token punctuation">.</span>Block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> ev<span class="token punctuation">.</span>Block
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				w<span class="token punctuation">.</span>remoteUncles<span class="token punctuation">[</span>ev<span class="token punctuation">.</span>Block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> ev<span class="token punctuation">.</span>Block
			<span class="token punctuation">}</span>
			<span class="token comment">// If our mining block contains less than 2 uncle blocks,</span>
			<span class="token comment">// add the new uncle block if valid and regenerate a mining block.</span>
			<span class="token keyword">if</span> w<span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> w<span class="token punctuation">.</span>current <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> w<span class="token punctuation">.</span>current<span class="token punctuation">.</span>uncles<span class="token punctuation">.</span><span class="token function">Cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token punctuation">{</span>
				start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">:=</span> w<span class="token punctuation">.</span><span class="token function">commitUncle</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span>current<span class="token punctuation">,</span> ev<span class="token punctuation">.</span>Block<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					<span class="token keyword">var</span> uncles <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header
					w<span class="token punctuation">.</span>current<span class="token punctuation">.</span>uncles<span class="token punctuation">.</span><span class="token function">Each</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
						hash<span class="token punctuation">,</span> ok <span class="token operator">:=</span> item<span class="token punctuation">.</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span>
						<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
							<span class="token keyword">return</span> <span class="token boolean">false</span>
						<span class="token punctuation">}</span>
						uncle<span class="token punctuation">,</span> exist <span class="token operator">:=</span> w<span class="token punctuation">.</span>localUncles<span class="token punctuation">[</span>hash<span class="token punctuation">]</span>
						<span class="token keyword">if</span> <span class="token operator">!</span>exist <span class="token punctuation">{</span>
							uncle<span class="token punctuation">,</span> exist <span class="token operator">=</span> w<span class="token punctuation">.</span>remoteUncles<span class="token punctuation">[</span>hash<span class="token punctuation">]</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">if</span> <span class="token operator">!</span>exist <span class="token punctuation">{</span>
							<span class="token keyword">return</span> <span class="token boolean">false</span>
						<span class="token punctuation">}</span>
						uncles <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>uncles<span class="token punctuation">,</span> uncle<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
						<span class="token keyword">return</span> <span class="token boolean">false</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span>
					w<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>uncles<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

		<span class="token keyword">case</span> ev <span class="token operator">:=</span> <span class="token operator">&lt;-</span>w<span class="token punctuation">.</span>txsCh<span class="token punctuation">:</span> <span class="token comment">// 接收NewTxsEvent</span>
			<span class="token comment">// Apply transactions to the pending state if we're not mining.</span>
			<span class="token comment">//</span>
			<span class="token comment">// Note all transactions received may not be continuous with transactions</span>
			<span class="token comment">// already included in the current mining block. These transactions will</span>
			<span class="token comment">// be automatically eliminated.</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>w<span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> w<span class="token punctuation">.</span>current <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// 节点不挖矿的话，调用commitTransactions()提交给EVM执行，获得本地回执</span>
				<span class="token comment">// If block is already full, abort</span>
				<span class="token keyword">if</span> gp <span class="token operator">:=</span> w<span class="token punctuation">.</span>current<span class="token punctuation">.</span>gasPool<span class="token punctuation">;</span> gp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> gp<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> params<span class="token punctuation">.</span>TxGas <span class="token punctuation">{</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">}</span>
				w<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				coinbase <span class="token operator">:=</span> w<span class="token punctuation">.</span>coinbase
				w<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

				txs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span>types<span class="token punctuation">.</span>Transactions<span class="token punctuation">)</span>
				<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> ev<span class="token punctuation">.</span>Txs <span class="token punctuation">{</span>
					acc<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">Sender</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span>current<span class="token punctuation">.</span>signer<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
					txs<span class="token punctuation">[</span>acc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>txs<span class="token punctuation">[</span>acc<span class="token punctuation">]</span><span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				txset <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">NewTransactionsByPriceAndNonce</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span>current<span class="token punctuation">.</span>signer<span class="token punctuation">,</span> txs<span class="token punctuation">)</span>
				tcount <span class="token operator">:=</span> w<span class="token punctuation">.</span>current<span class="token punctuation">.</span>tcount
				w<span class="token punctuation">.</span><span class="token function">commitTransactions</span><span class="token punctuation">(</span>txset<span class="token punctuation">,</span> coinbase<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
				<span class="token comment">// Only update the snapshot if any new transactons were added</span>
				<span class="token comment">// to the pending block</span>
				<span class="token keyword">if</span> tcount <span class="token operator">!=</span> w<span class="token punctuation">.</span>current<span class="token punctuation">.</span>tcount <span class="token punctuation">{</span>
					w<span class="token punctuation">.</span><span class="token function">updateSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 如果结点挖矿的话，miner会调用commitNewWork()，内部也会调用commitTransactions()执行交易</span>
				<span class="token comment">// Special case, if the consensus engine is 0 period clique(dev mode),</span>
				<span class="token comment">// submit mining work here since all empty submission will be rejected</span>
				<span class="token comment">// by clique. Of course the advance sealing(empty submission) is disabled.</span>
				<span class="token keyword">if</span> w<span class="token punctuation">.</span>chainConfig<span class="token punctuation">.</span>Clique <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> w<span class="token punctuation">.</span>chainConfig<span class="token punctuation">.</span>Clique<span class="token punctuation">.</span>Period <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
					w<span class="token punctuation">.</span><span class="token function">commitNewWork</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>w<span class="token punctuation">.</span>newTxs<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>Txs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token comment">// System stopped</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>w<span class="token punctuation">.</span>exitCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>w<span class="token punctuation">.</span>txsSub<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>w<span class="token punctuation">.</span>chainHeadSub<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>w<span class="token punctuation">.</span>chainSideSub<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br></div></div><p>如果结点不挖矿的话，这里会立即调用 commitTransactions() 提交给 EVM 执行，获得本地回执。</p> <p>如果结点挖矿的话，miner 会调用 commitNewWork()，内部也会调用 commitTransactions() 执行交易。</p> <h3 id="广播给其他节点"><a href="#广播给其他节点" class="header-anchor">#</a> 广播给其他节点</h3> <p>另一个订阅的地方位于eth/handler.go：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProtocolManager<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>maxPeers <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pm<span class="token punctuation">.</span>maxPeers <span class="token operator">=</span> maxPeers

	<span class="token comment">// broadcast transactions</span>
	pm<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	pm<span class="token punctuation">.</span>txsCh <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> core<span class="token punctuation">.</span>NewTxsEvent<span class="token punctuation">,</span> txChanSize<span class="token punctuation">)</span>
	pm<span class="token punctuation">.</span>txsSub <span class="token operator">=</span> pm<span class="token punctuation">.</span>txpool<span class="token punctuation">.</span><span class="token function">SubscribeNewTxsEvent</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>txsCh<span class="token punctuation">)</span>
	<span class="token keyword">go</span> pm<span class="token punctuation">.</span><span class="token function">txBroadcastLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 启动一个goroutine来接收NewTxsEvent事件</span>

	<span class="token comment">// broadcast mined blocks</span>
	pm<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	pm<span class="token punctuation">.</span>minedBlockSub <span class="token operator">=</span> pm<span class="token punctuation">.</span>eventMux<span class="token punctuation">.</span><span class="token function">Subscribe</span><span class="token punctuation">(</span>core<span class="token punctuation">.</span>NewMinedBlockEvent<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> pm<span class="token punctuation">.</span><span class="token function">minedBroadcastLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// start sync handlers</span>
	pm<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> pm<span class="token punctuation">.</span>chainSync<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> pm<span class="token punctuation">.</span><span class="token function">txsyncLoop64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// TODO(karalabe): Legacy initial tx echange, drop with eth/64.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>同样也是启动了一个 goroutine 来接收 NewTxsEvent 事件，看一下 txBroadcastLoop() 函数：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// txBroadcastLoop announces new transactions to connected peers.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProtocolManager<span class="token punctuation">)</span> <span class="token function">txBroadcastLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> pm<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> event <span class="token operator">:=</span> <span class="token operator">&lt;-</span>pm<span class="token punctuation">.</span>txsCh<span class="token punctuation">:</span>
			<span class="token comment">// For testing purpose only, disable propagation</span>
			<span class="token keyword">if</span> pm<span class="token punctuation">.</span>broadcastTxAnnouncesOnly <span class="token punctuation">{</span>
				pm<span class="token punctuation">.</span><span class="token function">BroadcastTransactions</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Txs<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			pm<span class="token punctuation">.</span><span class="token function">BroadcastTransactions</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Txs<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token comment">// First propagate transactions to peers</span>
			pm<span class="token punctuation">.</span><span class="token function">BroadcastTransactions</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Txs<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// Only then announce to the rest</span>

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>pm<span class="token punctuation">.</span>txsSub<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>跟踪 BroadcastTransactions() 函数：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// BroadcastTransactions will propagate a batch of transactions to all peers which are not known to</span>
<span class="token comment">// already have the given transaction.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProtocolManager<span class="token punctuation">)</span> <span class="token function">BroadcastTransactions</span><span class="token punctuation">(</span>txs types<span class="token punctuation">.</span>Transactions<span class="token punctuation">,</span> propagate <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		txset <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token operator">*</span>peer<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span>
		annos <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token operator">*</span>peer<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span>
	<span class="token punctuation">)</span>
	<span class="token comment">// Broadcast transactions to a batch of peers not knowing about it</span>
	<span class="token keyword">if</span> propagate <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> txs <span class="token punctuation">{</span>
			peers <span class="token operator">:=</span> pm<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">PeersWithoutTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

			<span class="token comment">// Send the block to a subset of our peers</span>
			transfer <span class="token operator">:=</span> peers<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">int</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span><span class="token function">Sqrt</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> peer <span class="token operator">:=</span> <span class="token keyword">range</span> transfer <span class="token punctuation">{</span>
				txset<span class="token punctuation">[</span>peer<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>txset<span class="token punctuation">[</span>peer<span class="token punctuation">]</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">&quot;Broadcast transaction&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hash&quot;</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;recipients&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span> peer<span class="token punctuation">,</span> hashes <span class="token operator">:=</span> <span class="token keyword">range</span> txset <span class="token punctuation">{</span>
			peer<span class="token punctuation">.</span><span class="token function">AsyncSendTransactions</span><span class="token punctuation">(</span>hashes<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Otherwise only broadcast the announcement to peers</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> txs <span class="token punctuation">{</span>
		peers <span class="token operator">:=</span> pm<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">PeersWithoutTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> peer <span class="token operator">:=</span> <span class="token keyword">range</span> peers <span class="token punctuation">{</span>
			annos<span class="token punctuation">[</span>peer<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>annos<span class="token punctuation">[</span>peer<span class="token punctuation">]</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> peer<span class="token punctuation">,</span> hashes <span class="token operator">:=</span> <span class="token keyword">range</span> annos <span class="token punctuation">{</span>
		<span class="token keyword">if</span> peer<span class="token punctuation">.</span>version <span class="token operator">&gt;=</span> eth65 <span class="token punctuation">{</span>
			peer<span class="token punctuation">.</span><span class="token function">AsyncSendPooledTransactionHashes</span><span class="token punctuation">(</span>hashes<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			peer<span class="token punctuation">.</span><span class="token function">AsyncSendTransactions</span><span class="token punctuation">(</span>hashes<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>会通过 P2P 向所有没有该交易的结点发送该交易。</p> <h2 id="markmap"><a href="#markmap" class="header-anchor">#</a> Markmap</h2> <p><a href="https://markmap.js.org/" target="_blank" rel="noopener noreferrer">https://markmap.js.org/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <embed src="https://kyrincode.github.io/attach/html/blockchain/markmap0.html" width="100%" height="200"> <div class="language-markdown line-numbers-mode"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> internal/ethapi/api.go: SendTransaction()</span>

<span class="token title important"><span class="token punctuation">##</span> internal/ethapi/api.go: SendTxArgs.toTransaction()</span>

<span class="token title important"><span class="token punctuation">###</span> core/types/transaction.go: NewContractCreation()</span>

<span class="token title important"><span class="token punctuation">###</span> core/types/transaction.go: NewTransaction()</span>

<span class="token title important"><span class="token punctuation">##</span> accounts/keystore/wallet.go: SignTx()</span>

<span class="token title important"><span class="token punctuation">###</span> accounts/keystore/keystore.go: SignTx()</span>

<span class="token title important"><span class="token punctuation">####</span> core/types/transaction_signing.go: SignTx()</span>

<span class="token title important"><span class="token punctuation">#####</span> core/types/transaction_signing.go: Hash()</span>

<span class="token title important"><span class="token punctuation">#####</span> crypto/signature_cgo.go: crypto.Sign()</span>

<span class="token title important"><span class="token punctuation">#####</span> core/types/transaction.go: WithSignature()</span>

<span class="token title important"><span class="token punctuation">######</span> core/types/transaction.go: SignatureValues()</span>

<span class="token title important"><span class="token punctuation">##</span> internal/ethapi/api.go: SubmitTransaction()</span>

<span class="token title important"><span class="token punctuation">###</span> eth/api_backend.go: SendTx()</span>

<span class="token title important"><span class="token punctuation">####</span> core/tx_pool.go: AddLocal()</span>

<span class="token title important"><span class="token punctuation">#####</span> core/tx_pool.go: AddLocals()</span>

<span class="token title important"><span class="token punctuation">######</span> core/tx_pool.go: addTxs()</span>

<span class="token list punctuation">-</span> core/tx<span class="token italic"><span class="token punctuation">_</span><span class="token content">pool.go: addTxsLocked()
  - core/tx</span><span class="token punctuation">_</span></span>pool.go: add()
    <span class="token list punctuation">-</span> core/tx<span class="token italic"><span class="token punctuation">_</span><span class="token content">pool.go: validateTx()
- core/tx</span><span class="token punctuation">_</span></span>pool.go: requestPromoteExecutables()

<span class="token title important"><span class="token punctuation">###</span> crypto/crypto.go: CreateAddress()</span>



<span class="token title important"><span class="token punctuation">#</span> core/tx_pool.go: NewTxPool()</span>

<span class="token title important"><span class="token punctuation">##</span> core/tx_pool.go: scheduleReorgLoop()</span>

<span class="token title important"><span class="token punctuation">###</span> core/tx_pool.go: runReorg()</span>

<span class="token title important"><span class="token punctuation">####</span> core/tx_pool.go: promoteExecutables()</span>

<span class="token title important"><span class="token punctuation">#####</span> core/tx_pool.go: promoteTx()</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <p><a href="https://blog.csdn.net/TurkeyCock/article/details/80485391" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/TurkeyCock/article/details/80485391<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">1/4/2021, 10:02:28 PM</span></div></footer> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-44bd5a18 data-v-44bd5a18><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-44bd5a18><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-44bd5a18></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-44bd5a18></path></svg></div></div></div>
    <script src="/assets/js/app.35d653e3.js" defer></script><script src="/assets/js/5.5164febf.js" defer></script><script src="/assets/js/1.2bbc4f55.js" defer></script><script src="/assets/js/10.c3d64b5d.js" defer></script>
  </body>
</html>
